<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <title>ä¿å«éƒ¨ä¸é¿éš¾ç‚¹è·¯å¾„è§„åˆ’</title>
    <style>
        body, html, #allmap {
            width: 100%;
            height: 100%;
            margin: 0;
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #141e30, #243b55);
            color: #ffffff;
        }
        #controls {
            position: absolute;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #controls button {
            background: linear-gradient(135deg, #e55d87, #5fc3e4);
            border: none;
            padding: 15px 25px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        #controls button:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        #logo {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 999;
        }
        #logo img {
            width: 150px;
            height: auto;
            filter: drop-shadow(0, 0, 255, 0.7);
        }
        #legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(36, 59, 85, 0.85);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            font-size: 16px;
            color: #ffffff;
        }
        #legend h4 {
            margin: 0 0 15px;
            font-weight: bold;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #5fc3e4;
        }
        #legend p {
            margin: 10px 0;
        }
        .legend-line {
            width: 60px;
            height: 6px;
            display: inline-block;
            margin-right: 15px;
            border-radius: 3px;
        }
        .legend-red { background-color: #ff5f6d; }
        .legend-blue { background-color: #5f9ff8; }
        .legend-green { background-color: #5cf87f; }
        .legend-area {
            width: 60px;
            height: 25px;
            display: inline-block;
            margin-right: 15px;
            background-color: rgba(255, 255, 0, 0.7);
            border: 1px solid #ffd700;
            border-radius: 5px;
        }
        #chat-container {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 300px;
            background: rgba(36, 59, 85, 0.85);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            font-size: 16px;
            color: #ffffff;
        }
        #chat-container h4 {
            margin: 0 0 15px;
            font-weight: bold;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #5fc3e4;
        }
        #chat-box {
            height: 150px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #5fc3e4;
            border-radius: 5px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        #chat-input {
            width: calc(100% - 20px);
            padding: 10px;
            border-radius: 5px;
            border: none;
            font-size: 14px;
            color: #ffffff;
            background-color: #2c3e50;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }
        #chat-input::placeholder {
            color: #ffffff;
            opacity: 0.7;
        }
        #chat-send {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #e55d87, #5fc3e4);
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        #chat-send:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        #weather-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 999;
            background-color: rgba(36, 59, 85, 0.85);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            font-size: 16px;
            color: #ffffff;
            text-align: center;
        }
        #weather-container h4 {
            margin: 0;
            font-size: 18px;
            color: #5fc3e4;
        }
        #weather-container p {
            margin: 5px 0;
        }
        
        /* Robot Style */
        #robot-container {
            position: absolute;
            top: 90px;
            left: 20px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .robot {
            font-size: 80px;
            margin-bottom: 2px;
            transition: transform 0.3s ease;
            animation: jump 1s infinite;
        }
        @keyframes jump {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        .robot-name {
            font-size: 18px;
            font-weight: bold;
            color: #5fc3e4;
            margin-bottom: 10px; /* å¢åŠ ä¸è¯ç­’æŒ‰é’®çš„é—´è· */
        }
        #start-recording {
            background: linear-gradient(135deg, #9b59b6,  #5fc3e4); /* ç´«åˆ°è“çš„æ¸å˜èƒŒæ™¯ */
            border: none;
            color: white;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0px 0px 20px rgba(155, 89, 182, 0.8);
            transition: all 0.3s ease;
            width: 60px;
            height: 60px;
            text-align: center;
        }
        #start-recording:hover {
            background: linear-gradient(135deg, #8e44ad,  #5fc3e4); /* æ‚¬åœæ—¶åŠ æ·±æ¸å˜é¢œè‰² */
            box-shadow: 0px 0px 40px rgba(155, 89, 182, 1);
        }

         /* Speech Status Box */
         #speech-status {
            display: none;
            margin-top: 10px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-size: 14px;
            border-radius: 25px;
            box-shadow: 0px 0px 20px rgba(231, 76, 60, 0.8);
            text-align: center;
            transition: all 0.5s ease;
         }

                 /* Copyright Section */
        #copyright {
            position: absolute;
            bottom: 0px;
            width: 100%;
            text-align: center;
            font-size: 14px;
            color: #000000;
            background-color: rgba(36, 59, 85, 0);
            padding: 6px 0;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
    </style>
    <script type="text/javascript" src="//api.map.baidu.com/api?v=2.0&ak=C8IhM8jTz7Dk4aXYmGeTkJhbNq713gdP"></script>
</head>
<body>
    <div id="logo">
        <img src="https://s2.loli.net/2024/08/13/ykHBlmOvGKSxX8e.png" alt="æ­¦æ±‰å¤§å­¦">
    </div>
    
     <!-- Robot Container -->
     <div id="robot-container">
        <div class="robot">ğŸ¤–</div>
        <div class="robot-name">çå°å®‰</div>
        <button id="start-recording">ğŸ¤</button>
        <div id="speech-status">æ­£åœ¨è®²è¯ä¸­...</div>
    </div>

    <div id="controls">
        <button onclick="goToWuhanUniversity()">å®šä½è‡³æ­¦æ±‰å¤§å­¦</button>
        <button onclick="sendRescueRequest()">å‘é€æ±‚æ•‘æ¶ˆæ¯</button>
        <button onclick="highlightClosestShelter()">æœ€è¿‘é¿éš¾ç‚¹</button>
        <button onclick="startNavigation()">è·¯çº¿å¯¼èˆª</button>
        <button onclick="replayRoutes()">å›æ”¾è·¯çº¿</button>
    </div>
    <div id="allmap"></div>
    <div id="legend">
        <h4>å›¾ä¾‹</h4>
        <p><span class="legend-line legend-red"></span>æœ€è¿‘çš„é¿éš¾ç‚¹è·¯å¾„</p>
        <p><span class="legend-line legend-green"></span>å…¶ä»–é¿éš¾ç‚¹è·¯å¾„</p>
        <p><span class="legend-line legend-blue"></span>ä¿å«éƒ¨æ•‘æ´è·¯å¾„</p>
        <p><span class="legend-area"></span>é«˜é£é™©åŒºåŸŸ</p>
    </div>
    <div id="chat-container">
        <h4>ç´§æ€¥å¯¹è¯</h4>
        <div id="chat-box"></div>
        <input id="chat-input" type="text" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." />
        <button id="chat-send">å‘é€</button>
    </div>
    
    <div id="weather-container">
        <h4>å®æ—¶å¤©æ°”</h4>
        <p id="weather">å¤©æ°”: -</p>
        <p id="temperature">æ¸©åº¦: -</p>
        <p id="wind">é£å‘: -</p>
        <p id="humidity">æ¹¿åº¦: -</p>
        <p id="reporttime">å‘å¸ƒæ—¶é—´: -</p>
    </div>
    <div id="copyright">
        Copyright Â© 2024 All Reserved ç‰ˆæƒæ‰€æœ‰ Wuhan University Pikaqiu
    </div>

    <script type="text/javascript">
       // å°†è¯­éŸ³è¯†åˆ«å’Œè¯­éŸ³åˆæˆåŠŸèƒ½æ”¾åœ¨çå°å®‰æœºå™¨äººé‡Œï¼Œç‚¹å‡»å½•éŸ³æŒ‰é’®æ—¶è§¦å‘
       async function recordAndRecognize() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'zh-CN';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            // æ˜¾ç¤ºâ€œæ­£åœ¨è®²è¯ä¸­...â€æç¤º
            const speechStatus = document.getElementById('speech-status');
            speechStatus.style.display = 'block';
            speechStatus.textContent = 'æ­£åœ¨è®²è¯ä¸­...';

            recognition.start();

            return new Promise((resolve, reject) => {
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    resolve(transcript);
                };

                recognition.onerror = (event) => {
                    reject(event.error);
                };

                recognition.onend = () => {
                    // æ›´æ–°æ–‡æœ¬æ¡†æç¤ºâ€œè®²è¯ç»“æŸâ€ï¼Œå¹¶åœ¨1ç§’åéšè—
                    speechStatus.textContent = 'è®²è¯ç»“æŸ';
                    setTimeout(() => {
                        speechStatus.style.display = 'none';
                    }, 1000);
                };
            });
        }

        // ä¸å›¾çµæœºå™¨äººå¯¹è¯
        async function talkToTuring(text) {
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            const apiUrl = 'http://openapi.tuling123.com/openapi/api/v2';
            const turingApiKey = '2b1477cbec794bd59992e47f5c03ea08';

            const req = {
                reqType: 0,
                perception: {
                    inputText: { text: text },
                    selfInfo: {
                        location: {
                            city: 'åŒ—äº¬',
                            province: 'åŒ—äº¬',
                            street: 'è¥¿äºŒæ——'
                        }
                    }
                },
                userInfo: {
                    apiKey: turingApiKey,
                    userId: 'Nieson'
                }
            };

            const response = await fetch(proxyUrl + apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json;charset=UTF-8' },
                body: JSON.stringify(req)
            });

            const responseJson = await response.json();
            return responseJson.results[0].values.text;
        }

        // è¯­éŸ³åˆæˆï¼Œå°†æœºå™¨äººçš„å›å¤æœ—è¯»å‡ºæ¥
        function speak(text) {
            const synth = window.speechSynthesis;
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = 'zh-CN';
            synth.speak(utterThis);
        }

        // è¯­éŸ³è¯†åˆ«è§¦å‘
        document.getElementById('start-recording').addEventListener('click', async () => {
            try {
                const userText = await recordAndRecognize();
                const robotResponse = await talkToTuring(userText);
                speak(robotResponse);
            } catch (error) {
                console.error('Error:', error);
                // éšè—æç¤ºæ¡†
                const speechStatus = document.getElementById('speech-status');
                speechStatus.textContent = 'è®²è¯ç»“æŸ';
                setTimeout(() => {
                    speechStatus.style.display = 'none';
                }, 1000);
            }
        });

        async function getWenxinResponse(inputText) {
            const accessToken = '24.e778301767bdf3e5d3fafbb579159774.2592000.1726215769.282335-83639541';
            const url = `https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions?access_token=${accessToken}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    messages: [
                        {
                            role: "user",
                            content: inputText
                        }
                    ]
                })
            });

            const data = await response.json();
            return data.result; // å‡è®¾è¿”å›ç»“æœåŒ…å«åœ¨ `result` å­—æ®µä¸­
        }

            // è‡ªå®šä¹‰ Markdown è§£æå‡½æ•°
        function parseMarkdown(markdownText) {
            let htmlText = markdownText
                .replace(/^### (.*$)/gim, '<h3>$1</h3>') // ä¸‰çº§æ ‡é¢˜
                .replace(/^## (.*$)/gim, '<h2>$1</h2>') // äºŒçº§æ ‡é¢˜
                .replace(/^# (.*$)/gim, '<h1>$1</h1>') // ä¸€çº§æ ‡é¢˜
                .replace(/^\> (.*$)/gim, '<blockquote>$1</blockquote>') // å¼•ç”¨
                .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>') // ç²—ä½“
                .replace(/\*(.*)\*/gim, '<i>$1</i>') // æ–œä½“
                .replace(/\[(.*?)\]\((.*?)\)/gim, '<a href="$2">$1</a>') // é“¾æ¥
                .replace(/\n$/gim, '<br />') // æ¢è¡Œ
                .replace(/^\- (.*$)/gim, '<ul><li>$1</li></ul>') // æ— åºåˆ—è¡¨
                .replace(/^\d+\.\s+(.*$)/gim, '<ol><li>$1</li></ol>'); // æœ‰åºåˆ—è¡¨

            // ç§»é™¤åˆ—è¡¨çš„åŒ…è£¹ (å› ä¸ºæ¯æ¬¡éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ ul æˆ– olï¼Œå®é™…éœ€è¦çš„æ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰åˆ—è¡¨é¡¹çš„ ul/ol)
            htmlText = htmlText.replace(/<\/ul>\s*<ul>/g, '').replace(/<\/ol>\s*<ol>/g, '');

            return htmlText.trim(); // è¿”å›æ ¼å¼åŒ–åçš„ HTML
        }

        document.getElementById("chat-send").addEventListener("click", async function() {
            var input = document.getElementById("chat-input").value;
            if (input.trim() === "") return;

            var chatBox = document.getElementById("chat-box");
            chatBox.innerHTML += "<p><strong>æ‚¨:</strong> " + input + "</p>";
            document.getElementById("chat-input").value = "";

            try {
                var response = await getWenxinResponse(input);

                // ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°è§£æ Markdown
                var formattedResponse = parseMarkdown(response);

                chatBox.innerHTML += "<p><strong>çå°å®‰:</strong> " + formattedResponse + "</p>";
            } catch (error) {
                chatBox.innerHTML += "<p><strong>çå°å®‰:</strong> è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>";
            }

            chatBox.scrollTop = chatBox.scrollHeight;
        });
        
        // ç™¾åº¦åœ°å›¾åˆå§‹åŒ–å’Œå…¶ä»–åŠŸèƒ½ä»£ç 
        var bm, userMarker, closestShelterMarker, lastRouteOverlay = null, lastSecurityRouteOverlay = null;
        var recordedRoutes = [];
        var departments = [
            {lng: 114.366787, lat: 30.549754, name: "æ­¦æ±‰å¤§å­¦ä¿å«éƒ¨"},
            {lng: 114.370645, lat: 30.539183, name: "æ­¦æ±‰å¤§å­¦ä¿å«éƒ¨ä¸€åˆ†éƒ¨"},
            {lng: 114.366863, lat: 30.549839, name: "æ­¦æ±‰å¤§å­¦ä¿å«éƒ¨äºŒåˆ†éƒ¨"},
            {lng: 114.365286, lat: 30.534478, name: "æ­¦æ±‰å¤§å­¦ä¿å«éƒ¨ä¸‰åˆ†éƒ¨"},
            {lng: 114.363636, lat: 30.560257, name: "æ­¦æ±‰å¤§å­¦ä¿å«éƒ¨å››åˆ†éƒ¨"}
        ];

        var shelters = [
            {lng: 114.379157, lat: 30.540523},
            {lng: 114.370434, lat: 30.539846},
            {lng: 114.370911, lat: 30.541526},
            {lng: 114.378151, lat: 30.54319},
            {lng: 114.372024, lat: 30.538859},
            {lng: 114.373713, lat: 30.538696},
            {lng: 114.381331, lat: 30.54284},
            {lng: 114.375896, lat: 30.543322},
            {lng: 114.374809, lat: 30.542125},
            {lng: 114.376741, lat: 30.54235},
            {lng: 114.376723, lat: 30.538944},
            {lng: 114.370461, lat: 30.542828},
            {lng: 114.365952, lat: 30.545115},
            {lng: 114.367061, lat: 30.544384},
            {lng: 114.373556, lat: 30.538369},
            {lng: 114.377751, lat: 30.544838},
            {lng: 114.379997, lat: 30.543649},
            {lng: 114.369051, lat: 30.54043},
            {lng: 114.370273, lat: 30.545939},
            {lng: 114.376691, lat: 30.548862},
            {lng: 114.37666, lat: 30.547634},
            {lng: 114.377783, lat: 30.547366},
            {lng: 114.365413, lat: 30.546596},
            {lng: 114.366239, lat: 30.547163},
            {lng: 114.372833, lat: 30.54749},
            {lng: 114.377603, lat: 30.544119},
            {lng: 114.358037, lat: 30.560217},
            {lng: 114.361433, lat: 30.562005},
            {lng: 114.356034, lat: 30.560069},
            {lng: 114.357615, lat: 30.56143},
            {lng: 114.359789, lat: 30.559844},
            {lng: 114.363032, lat: 30.5449},
            {lng: 114.363166, lat: 30.548761},
            {lng: 114.365412, lat: 30.551093},
            {lng: 114.366086, lat: 30.539267},
            {lng: 114.362367, lat: 30.533613},
            {lng: 114.365237, lat: 30.532742},
            {lng: 114.364357, lat: 30.534364},
            {lng: 114.362282, lat: 30.533633},
            {lng: 114.365246, lat: 30.53763}
        ];

        // åˆå§‹åŒ–ç™¾åº¦åœ°å›¾
        function initMap() {
            bm = new BMap.Map("allmap");
            bm.enableScrollWheelZoom(true);
            bm.centerAndZoom(new BMap.Point(114.37268, 30.542848), 15); // è®¾ç½®ä¸­å¿ƒç‚¹å’Œç¼©æ”¾çº§åˆ«

            // å¦‚æœç”¨æˆ·å…è®¸è·å–åœ°ç†ä½ç½®ï¼Œåˆ™æ˜¾ç¤ºç”¨æˆ·ä½ç½®
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    // è·å–WGS84åæ ‡
                    var x = position.coords.longitude;
                    var y = position.coords.latitude;
                    var ggPoint = new BMap.Point(x, y);

                    // åæ ‡è½¬æ¢å®Œä¹‹åçš„å›è°ƒå‡½æ•°
                    translateCallback = function (data) {
                        if (data.status === 0) {
                            var userPoint = data.points[0];
                            userMarker = new BMap.Marker(userPoint);
                            bm.addOverlay(userMarker);
                            bm.centerAndZoom(userPoint, 15);

                            var label = new BMap.Label("æ‚¨çš„å½“å‰ä½ç½®", {offset: new BMap.Size(20, -10)});
                            userMarker.setLabel(label);

                            // æ·»åŠ é¿éš¾ç‚¹å’Œä¿å«éƒ¨
                            addShelters();
                            addSecurityDepartments();
                            addRiskZones();
                        }
                    };

                    // ä½¿ç”¨ç™¾åº¦åœ°å›¾çš„Convertorå°†WGS84è½¬æ¢ä¸ºBD09
                    var convertor = new BMap.Convertor();
                    var pointArr = [];
                    pointArr.push(ggPoint);
                    convertor.translate(pointArr, 1, 5, translateCallback);
                }, function () {
                    alert("æ— æ³•è·å–æ‚¨çš„ä½ç½®ï¼Œè¯·ç¡®ä¿å·²æˆæƒè®¿é—®ä½ç½®ã€‚");
                    initMapWithDefaultCenter();
                });
            } else {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½ã€‚");
                initMapWithDefaultCenter();
            }

            // ç‚¹å‡»åœ°å›¾ç”Ÿæˆåˆ°æ‰€æœ‰é¿éš¾ç‚¹å’Œä¿å«éƒ¨çš„é€ƒç”ŸåŠå›´å µè·¯å¾„ï¼Œå¹¶å¯åŠ¨è¯­éŸ³æ’­æŠ¥
            bm.addEventListener("click", function(e){
                planRoutesFromClick(e.point);
                planSecurityRoutesFromClick(e.point);
                getDistrictAdcodeAndFetchWeather(e.point);
            });
        }

        // æ·»åŠ é¿éš¾ç‚¹
        function addShelters() {
            shelters.forEach(function(shelter, index) {
                var shelterPoint = new BMap.Point(shelter.lng, shelter.lat);
                var shelterMarker = new BMap.Marker(shelterPoint);
                bm.addOverlay(shelterMarker);
                var label = new BMap.Label("é¿éš¾ç‚¹ " + (index + 1), {offset: new BMap.Size(20, -10)});
                label.setStyle({
                    color: "#000000", 
                    fontSize: "12px", 
                    backgroundColor: "rgba(255, 255, 255, 0.8)", 
                    border: "1px solid #FF0000", 
                    borderRadius: "5px",
                    boxShadow: "0px 0px 5px rgba(0, 0, 0, 0.5)"
                });
                shelterMarker.setLabel(label);
            });
        }

        // æ·»åŠ æ­¦æ±‰å¤§å­¦ä¿å«éƒ¨åŠå…¶åˆ†éƒ¨
        function addSecurityDepartments() {
            departments.forEach(function(dept, index) {
                var deptPoint = new BMap.Point(dept.lng, dept.lat);
                var deptMarker = new BMap.Marker(deptPoint);
                bm.addOverlay(deptMarker);
                var label = new BMap.Label(dept.name, {offset: new BMap.Size(20, -10)});
                label.setStyle({
                    color: "#0056b3", 
                    fontSize: "14px", 
                    backgroundColor: "rgba(255, 255, 255, 0.8)", 
                    border: "1px solid #0056b3",
                    borderRadius: "5px",
                    boxShadow: "0px 0px 5px rgba(0, 0, 0, 0.5)"
                });
                deptMarker.setLabel(label);
            });
        }

        // æ·»åŠ é«˜é£é™©åŒºåŸŸ
        function addRiskZones() {
            var riskZones = [
                {center: {lng: 114.366693, lat: 30.537925}, radius: 150},
                {center: {lng: 114.367358, lat: 30.549526}, radius: 250},
                {center: {lng: 114.376287, lat: 30.54189}, radius: 300}
            ];

            riskZones.forEach(function(zone) {
                var circle = new BMap.Circle(new BMap.Point(zone.center.lng, zone.center.lat), zone.radius, {
                    strokeColor: "yellow", 
                    strokeWeight: 2, 
                    strokeOpacity: 0.5, 
                    fillColor: "yellow", 
                    fillOpacity: 0.3
                });
                bm.addOverlay(circle);
            });
        }

        // è·å–åŒºåŸŸadcodeå¹¶è·å–å¤©æ°”ä¿¡æ¯
        function getDistrictAdcodeAndFetchWeather(point) {
            var geoc = new BMap.Geocoder();    
            geoc.getLocation(point, function(rs) {
                var addComp = rs.addressComponents;
                var districtName = addComp.district; // è·å–åŒºåç§°
                var adcode = getAdcodeByDistrict(districtName);
                if (adcode) {
                    fetchWeather(adcode);
                } else {
                    console.error("æ— æ³•æ‰¾åˆ°å¯¹åº”çš„åŒºåŸŸç¼–ç ã€‚");
                }
            }, {
                enableRegion: true
            });
        }

        // æ ¹æ®åŒºåç§°è·å–adcode
        function getAdcodeByDistrict(district) {
            var adcodes = {
                "æ±Ÿå²¸åŒº": "420102",
                "æ±Ÿæ±‰åŒº": "420103",
                "ç¡šå£åŒº": "420104",
                "æ±‰é˜³åŒº": "420105",
                "æ­¦æ˜ŒåŒº": "420106",
                "é’å±±åŒº": "420107",
                "æ´ªå±±åŒº": "420111",
                "ä¸œè¥¿æ¹–åŒº": "420112",
                "æ±‰å—åŒº": "420113",
                "è”¡ç”¸åŒº": "420114",
                "æ±Ÿå¤åŒº": "420115",
                "é»„é™‚åŒº": "420116",
                "æ–°æ´²åŒº": "420117"
            };
            return adcodes[district] || null;
        }

        // è·å–å¤©æ°”ä¿¡æ¯
        async function fetchWeather(adcode) {
            const apiKey = "b759cb453fad31222ce6da0a705fdc44";
            const url = `https://restapi.amap.com/v3/weather/weatherInfo?city=${adcode}&key=${apiKey}&extensions=base`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.status === '1') {
                    updateWeatherInfo(data.lives[0]);
                } else {
                    console.error("å¤©æ°”ä¿¡æ¯è·å–å¤±è´¥:", data.info);
                }
            } catch (error) {
                console.error("è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥:", error);
            }
        }

        // æ›´æ–°å¤©æ°”ä¿¡æ¯æ˜¾ç¤º
        function updateWeatherInfo(weatherData) {
            document.getElementById("weather").textContent = `å¤©æ°”: ${weatherData.weather}`;
            document.getElementById("temperature").textContent = `æ¸©åº¦: ${weatherData.temperature}â„ƒ`;
            document.getElementById("wind").textContent = `é£å‘: ${weatherData.winddirection} ${weatherData.windpower}çº§`;
            document.getElementById("humidity").textContent = `æ¹¿åº¦: ${weatherData.humidity}%`;
            document.getElementById("reporttime").textContent = `å‘å¸ƒæ—¶é—´: ${weatherData.reporttime}`;
        }

// ä»ç‚¹å‡»çš„åœ°å›¾ä½ç½®ç”Ÿæˆåˆ°æ‰€æœ‰é¿éš¾ç‚¹çš„é€ƒç”Ÿè·¯çº¿ï¼Œå¹¶è¿›è¡Œè¯­éŸ³æ’­æŠ¥
function planRoutesFromClick(clickPoint) {
            bm.clearOverlays();  // æ¸…é™¤ä¹‹å‰çš„è¦†ç›–ç‰©
            bm.addOverlay(userMarker);  // ä¿ç•™ç”¨æˆ·ä½ç½®
            addShelters();  // é‡æ–°æ·»åŠ é¿éš¾ç‚¹
            addSecurityDepartments();  // é‡æ–°æ·»åŠ ä¿å«éƒ¨
            addRiskZones(); // é‡æ–°æ·»åŠ é«˜é£é™©åŒºåŸŸ

            var minDistance = Infinity;
            var closestShelterPoint = null;
            var closestShelterIndex = -1;
            var closestShelterMarker = null;

            shelters.forEach(function(shelter, index) {
                var shelterPoint = new BMap.Point(shelter.lng, shelter.lat);
                var shelterMarker = new BMap.Marker(shelterPoint);
                bm.addOverlay(shelterMarker);
                var label = new BMap.Label("é¿éš¾ç‚¹ " + (index + 1), {offset: new BMap.Size(20, -10)});
                label.setStyle({
                    color: "#000000", 
                    fontSize: "12px", 
                    backgroundColor: "rgba(255, 255, 255, 0.8)", 
                    border: "1px solid #FF0000", 
                    borderRadius: "5px",
                    boxShadow: "0px 0px 5px rgba(0, 0, 0, 0.5)"
                });
                shelterMarker.setLabel(label);

                var walking = new BMap.WalkingRoute(bm, {
                    renderOptions: {map: bm, autoViewport: false, strokeColor: "#808080", strokeWeight: 3}
                });

                walking.search(clickPoint, shelterPoint);

                walking.setSearchCompleteCallback(function(results) {
                    if (walking.getStatus() == BMAP_STATUS_SUCCESS) {
                        var distance = bm.getDistance(clickPoint, shelterPoint);
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestShelterPoint = shelterPoint;
                            closestShelterIndex = index + 1;
                            closestShelterMarker = shelterMarker;
                        }
                    }

                    if (index === shelters.length - 1) {  // å½“æ‰€æœ‰é¿éš¾ç‚¹éƒ½è®¡ç®—å®Œè·¯å¾„åï¼Œå¤„ç†æœ€è¿‘çš„é¿éš¾ç‚¹
                        highlightClosestRoute(clickPoint, closestShelterPoint, closestShelterIndex, closestShelterMarker);
                    }
                });
            });
        }

        // é«˜äº®æœ€è¿‘çš„è·¯å¾„å¹¶è¯­éŸ³æ’­æŠ¥ï¼ŒåŒæ—¶è®©æœ€è¿‘çš„é¿éš¾ç‚¹è·³è·ƒå’Œé—ªçƒ
        function highlightClosestRoute(clickPoint, closestShelterPoint, closestShelterIndex, closestShelterMarker) {
            // å…ˆæ¸…é™¤å·²æœ‰çš„é«˜äº®è·¯å¾„
            if (lastRouteOverlay) {
                bm.removeOverlay(lastRouteOverlay);
            }

            var walking = new BMap.WalkingRoute(bm, {
                renderOptions: {map: bm, autoViewport: true, strokeColor: "red", strokeWeight: 6}
            });

            walking.search(clickPoint, closestShelterPoint);

            walking.setSearchCompleteCallback(function(results) {
                if (walking.getStatus() == BMAP_STATUS_SUCCESS) {
                    var distance = results.getPlan(0).getDistance(true);
                    var duration = results.getPlan(0).getDuration(true);
                    var content = "è·ç¦»æœ€è¿‘çš„æ˜¯é¿éš¾ç‚¹ " + closestShelterIndex + "ï¼Œè·ç¦»ï¼š" + distance + "ï¼Œé¢„è®¡è€—æ—¶ï¼š" + duration;
                    speak(content);

                    // è·å–å¹¶ç»˜åˆ¶æœ€çŸ­è·¯å¾„
                    var points = results.getPlan(0).getRoute(0).getPath();
                    lastRouteOverlay = new BMap.Polyline(points, {strokeColor: "red", strokeWeight: 6, strokeOpacity: 1});
                    bm.addOverlay(lastRouteOverlay); // å°†æœ€çŸ­è·¯å¾„æ·»åŠ åˆ°åœ°å›¾å¹¶ç½®äºé¡¶å±‚
                    saveRoute(points);

                    // è®©æœ€è¿‘çš„é¿éš¾ç‚¹è·³è·ƒ
                    closestShelterMarker.setAnimation(BMAP_ANIMATION_BOUNCE);

                    // é—ªçƒæ•ˆæœåŠæ ‡ç­¾é¢œè‰²å˜åŒ–
                    var shelterLabel = closestShelterMarker.getLabel();
                    var originalContent = shelterLabel.getContent();
                    var toggleVisibility = true;
                    setInterval(function() {
                        toggleVisibility = !toggleVisibility;
                        shelterLabel.setContent(toggleVisibility ? originalContent : "");
                        shelterLabel.setStyle({color: toggleVisibility ? "red" : "#000000"});
                    }, 500);
                }
            });
        }

        // é«˜äº®æœ€è¿‘çš„é¿éš¾ç‚¹
        function highlightClosestShelter() {
            var minDistance = Infinity;
            var closestShelterMarker = null;
            var closestShelterLabel = null;

            shelters.forEach(function(shelter, index) {
                var shelterPoint = new BMap.Point(shelter.lng, shelter.lat);
                var distance = bm.getDistance(userMarker.getPosition(), shelterPoint);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestShelterMarker = new BMap.Marker(shelterPoint);
                    closestShelterLabel = new BMap.Label("é¿éš¾ç‚¹ " + (index + 1), {offset: new BMap.Size(20, -10)});
                }
            });

            if (closestShelterMarker) {
                bm.addOverlay(closestShelterMarker);
                closestShelterMarker.setAnimation(BMAP_ANIMATION_BOUNCE);

                closestShelterLabel.setStyle({
                    color: "#000000",
                    fontSize: "12px",
                    backgroundColor: "rgba(255, 255, 255, 0.8)",
                    border: "1px solid #FF0000",
                    borderRadius: "5px",
                    boxShadow: "0px 0px 5px rgba(0, 0, 0, 0.5)"
                });
                closestShelterMarker.setLabel(closestShelterLabel);

                // æ–‡å­—æ ‡è¯†é—ªçƒæ•ˆæœ
                var originalContent = closestShelterLabel.getContent();
                var toggleVisibility = true;
                setInterval(function() {
                    toggleVisibility = !toggleVisibility;
                    closestShelterLabel.setContent(toggleVisibility ? originalContent : "");
                    closestShelterLabel.setStyle({color: toggleVisibility ? "red" : "#000000"});
                }, 500);
            }
        }

        // ä»ç‚¹å‡»ä½ç½®åˆ°ä¿å«éƒ¨çš„è·¯å¾„
        function planSecurityRoutesFromClick(clickPoint) {
            var minDistance = Infinity;
            var closestDeptPoint = null;
            var closestDeptIndex = -1;
            var closestDeptMarker = null;

            departments.forEach(function(dept, index) {
                var deptPoint = new BMap.Point(dept.lng, dept.lat);
                var deptMarker = new BMap.Marker(deptPoint);
                bm.addOverlay(deptMarker);
                var label = new BMap.Label(dept.name, {offset: new BMap.Size(20, -10)});
                label.setStyle({
                    color: "#0056b3", 
                    fontSize: "14px", 
                    backgroundColor: "rgba(255, 255, 255, 0.8)", 
                    border: "1px solid #0056b3",
                    borderRadius: "5px",
                    boxShadow: "0px 0px 5px rgba(0, 0, 0, 0.5)"
                });
                deptMarker.setLabel(label);

                var driving = new BMap.DrivingRoute(bm, {
                    renderOptions: {map: bm, autoViewport: false, strokeColor: "#808080", strokeWeight: 3}
                });

                driving.search(deptPoint, clickPoint);

                driving.setSearchCompleteCallback(function(results) {
                    if (driving.getStatus() == BMAP_STATUS_SUCCESS) {
                        var distance = bm.getDistance(deptPoint, clickPoint);
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestDeptPoint = deptPoint;
                            closestDeptIndex = index + 1;
                            closestDeptMarker = deptMarker;
                        }
                    }

                    if (index === departments.length - 1) {  // å½“æ‰€æœ‰ä¿å«éƒ¨éƒ½è®¡ç®—å®Œè·¯å¾„åï¼Œå¤„ç†æœ€è¿‘çš„ä¿å«éƒ¨
                        highlightClosestSecurityRoute(clickPoint, closestDeptPoint, closestDeptIndex, closestDeptMarker);
                    }
                });
            });
        }

        // é«˜äº®æœ€è¿‘çš„ä¿å«éƒ¨è·¯å¾„
        function highlightClosestSecurityRoute(clickPoint, closestDeptPoint, closestDeptIndex, closestDeptMarker) {
            // å…ˆæ¸…é™¤å·²æœ‰çš„é«˜äº®è·¯å¾„
            if (lastSecurityRouteOverlay) {
                bm.removeOverlay(lastSecurityRouteOverlay);
            }

            var driving = new BMap.DrivingRoute(bm, {
                renderOptions: {map: bm, autoViewport: true, strokeColor: "blue", strokeWeight: 4}
            });

            driving.search(closestDeptPoint, clickPoint);

            driving.setSearchCompleteCallback(function(results) {
                if (driving.getStatus() == BMAP_STATUS_SUCCESS) {
                    var distance = results.getPlan(0).getDistance(true);
                    var duration = results.getPlan(0).getDuration(true);
                    var content = "æœ€è¿‘çš„æ˜¯" + departments[closestDeptIndex - 1].name + "ï¼Œè·ç¦»ï¼š" + distance + "ï¼Œé¢„è®¡éª‘è¡Œæ—¶é—´ï¼š" + duration;
                    speak(content);

                    // è·å–å¹¶ç»˜åˆ¶æœ€çŸ­è·¯å¾„
                    var points = results.getPlan(0).getRoute(0).getPath();
                    lastSecurityRouteOverlay = new BMap.Polyline(points, {strokeColor: "blue", strokeWeight: 4, strokeOpacity: 1});
                    bm.addOverlay(lastSecurityRouteOverlay); // å°†æœ€çŸ­è·¯å¾„æ·»åŠ åˆ°åœ°å›¾å¹¶ç½®äºé¡¶å±‚
                    saveRoute(points);

                    // è®©æœ€è¿‘çš„ä¿å«éƒ¨è·³è·ƒ
                    closestDeptMarker.setAnimation(BMAP_ANIMATION_BOUNCE);
                }
            });
        }

        // ä½¿ç”¨Web Speech APIè¿›è¡Œè¯­éŸ³æ’­æŠ¥
        function speak(text) {
            if ('speechSynthesis' in window) {
                var msg = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(msg);
            } else {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½ã€‚");
            }
        }

        // å®šä½åˆ°æ­¦æ±‰å¤§å­¦
        function goToWuhanUniversity() {
            var wuPoint = new BMap.Point(114.37268, 30.542848);
            bm.centerAndZoom(wuPoint, 18);
            var wuMarker = new BMap.Marker(wuPoint);
            bm.addOverlay(wuMarker);
            var label = new BMap.Label("æ­¦æ±‰å¤§å­¦", {offset: new BMap.Size(20, -10)});
            wuMarker.setLabel(label);
        }

        // å¦‚æœç”¨æˆ·æ‹’ç»ä½ç½®è®¿é—®æˆ–æ— æ³•è·å–ä½ç½®ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®åˆå§‹åŒ–åœ°å›¾
        function initMapWithDefaultCenter() {
            var defaultPoint = new BMap.Point(114.37268, 30.542848);
            bm.centerAndZoom(defaultPoint, 15);
            goToWuhanUniversity();
        }

        // ä¿å­˜è·¯å¾„
        function saveRoute(route) {
            recordedRoutes.push(route);
        }

        // å›æ”¾è·¯å¾„
        function replayRoutes() {
            recordedRoutes.forEach(function(route, index) {
                setTimeout(function() {
                    bm.addOverlay(new BMap.Polyline(route, {strokeColor: "purple", strokeWeight: 4, strokeOpacity: 0.8}));
                }, index * 1000); // æ¯ç§’å›æ”¾ä¸€ä¸ªè·¯å¾„
            });
        }

        // ç´§æ€¥æ•‘æ´è¯·æ±‚
        function sendRescueRequest() {
            var currentLocation = userMarker.getPosition();
            var message = "ç´§æ€¥æ•‘æ´è¯·æ±‚ï¼šç”¨æˆ·ä½ç½® - " + currentLocation.lng + ", " + currentLocation.lat;
            alert("æ•‘æ´è¯·æ±‚å·²å‘é€ï¼š" + message);
            // å®é™…å®ç°å¯ä»¥é€šè¿‡APIè°ƒç”¨å‘é€çŸ­ä¿¡æˆ–é‚®ä»¶
        }

        // å¼€å§‹å¯¼èˆªæ¨¡æ‹Ÿ
        function startNavigation() {
            if (!lastRouteOverlay) {
                alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¿éš¾ç‚¹æˆ–ç›®çš„åœ°ã€‚");
                return;
            }
            var points = lastRouteOverlay.getPath();
            points.forEach(function(point, index) {
                setTimeout(function() {
                    userMarker.setPosition(point);
                }, index * 300); // æ¯ç§’ç§»åŠ¨ä¸€æ­¥
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–åœ°å›¾
        window.onload = initMap;
    </script>
</body>
</html>

